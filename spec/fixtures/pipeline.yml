---

#####################################################################################
resources:

# Docker
- name: docker-alpine
  type: docker-image
  icon: docker
  source:
    repository: alpine

# Others
- name: mqtt-broker
  type: mqtt-resource
  icon: cloud-outline
  source:
    url: mqtt://mqttbroker.andrelademann.de
    topic: project/alert
    prefix: project/trigger
    username: vergissberlin
    password: oJT9U7swNc7fS6E9SnfIqzKP

#####################################################################################
resource_types:

- name: mqtt-resource
  type: docker-image
  source:
    repository: vergissberlin/mqtt-resource
    tag: development


#####################################################################################
jobs:

- name: test
  serial: true
  build_logs_to_retain: 10
  plan:
  - aggregate:
    - get: docker-alpine
      trigger: true
    - get: mqtt-broker
      trigger: true
  - task: test
    privileged: true
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: alpine
      inputs:
      - name: docker-alpine
      outputs:
      - name: out
      run:
        path: sh
        args:
        - -exc
        - |
          echo "Hello World"
  on_success:
    put: mqtt-broker
    params:
      payload: Release success
  on_failure:
    put: mqtt-broker
    params:
      topic: my/overridden/topic
      payload: Release failure
  on_abort:
    put: mqtt-broker
    params:
      payload: Release aborted
